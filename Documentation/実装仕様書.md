# ElkEngine 技術仕様書

## 1. プロジェクト概要

**プロジェクト名:** ElkEngine  
**種別:** ゲームエンジン + エディタ  
**アーキテクチャ:** ブリッジ統合型 (C++20コア + C# WPFエディタ)  
**対象プラットフォーム:** Windows 11 (x64)  
**グラフィックスAPI:** DirectX 12 / Vulkan  
**バージョン:** 0.1.0  

## 2. システムアーキテクチャ

### 2.1 全体構成
```
┌─────────────────────────────────────┐
│     C# WPF エディタレイヤー          │
│  ・プロジェクト管理                  │
│  ・アセットブラウザ                  │
│  ・シーンエディタ                    │
├─────────────────────────────────────┤
│   C++ EditorBridge (P/Invoke)       │
│  ・C APIエクスポート                 │
│  ・データマーシャリング              │
├─────────────────────────────────────┤
│      C++ ElkEngine コア              │
│  ・レンダリングシステム              │
│  ・ECS (Entity Component System)     │
│  ・物理エンジン                      │
└─────────────────────────────────────┘
```

### 2.2 ディレクトリ構造
```
ElkGameEngine/
├─ Assets/                  # ゲームアセット
├─ Documentation/           # プロジェクトドキュメント
│  ├─ 技術仕様書.md         # このファイル
│  ├─ API仕様書.md
│  └─ コーディング規約.md
├─ Editor/                  # C# WPFエディタ
│  ├─ ElkEditor.csproj
│  ├─ ViewModels/
│  ├─ Views/
│  ├─ Services/
│  └─ Interop/
├─ EditorBridge/            # C++ブリッジライブラリ
│  ├─ Public/
│  │  └─ EditorBridge.h
│  ├─ Private/
│  └─ CMakeLists.txt
├─ ElkEngine/               # C++20エンジンコア
│  ├─ Public/
│  │  ├─ Core/
│  │  ├─ Renderer/
│  │  └─ ECS/
│  ├─ Private/
│  │  └─ Platforms/
│  │     ├─ Windows/
│  │     ├─ DirectX12/
│  │     └─ Vulkan/
│  └─ ThirdParty/
├─ Runtime/                 # ゲームランタイム
├─ Samples/                 # サンプルプロジェクト
├─ Scripts/                 # ビルドスクリプト
├─ ThirdParty/              # 外部ライブラリ
└─ build/                   # ビルド出力
```

## 3. 技術スタック

### 3.1 コア技術

| コンポーネント | 技術 | バージョン | 理由 |
|--------------|------|-----------|------|
| **言語** | C++20 | - | モダンC++機能活用 |
| **コンパイラ** | MSVC | 2022 | 最新機能サポート |
| **ビルドシステム** | CMake | 4.0+ | C++20対応 |
| **グラフィックスAPI** | DirectX 12 / Vulkan | - | 次世代レンダリング |
| **エディタUI** | WPF | .NET 9 | 高い生産性 |

### 3.2 C++20機能の活用

```cpp
// コンセプトによる型制約
template<typename T>
concept Component = requires(T t) {
    { t.GetTypeId() } -> std::convertible_to<size_t>;
};

// コルーチンによる非同期処理
Task<Model> LoadModelAsync(std::string_view path) {
    auto data = co_await ReadFileAsync(path);
    co_return ParseModel(data);
}

// モジュールシステム
export module elk.core;
export namespace elk {
    class Engine { /* ... */ };
}

// Ranges による関数型プログラミング
auto activeEntities = entities 
    | std::views::filter([](const auto& e) { return e.IsActive(); })
    | std::views::transform([](const auto& e) { return e.GetId(); });
```

## 4. コアAPI設計

### 4.1 Engine クラス
```cpp
namespace elk {
    class [[nodiscard]] ENGINE_API Engine final {
    public:
        Engine() = default;
        ~Engine() = default;
        
        // 削除されたコピー/ムーブ
        Engine(const Engine&) = delete;
        Engine& operator=(const Engine&) = delete;
        Engine(Engine&&) = delete;
        Engine& operator=(Engine&&) = delete;
        
        [[nodiscard]] bool Initialize(const EngineConfig& config);
        void Run(std::unique_ptr<Application> app);
        void Shutdown();
        
        [[nodiscard]] static Engine& GetInstance() noexcept;
        
    private:
        struct Impl;
        std::unique_ptr<Impl> m_pImpl;
    };
}
```

### 4.2 Application インターフェース
```cpp
namespace elk {
    class APPLICATION_API Application {
    public:
        Application() = default;
        virtual ~Application() = default;
        
        // ライフサイクル
        [[nodiscard]] virtual bool Initialize() = 0;
        virtual void Update(std::chrono::duration<float> deltaTime) = 0;
        virtual void Render() = 0;
        virtual void Shutdown() = 0;
        
        // メタデータ
        [[nodiscard]] virtual std::string_view GetName() const noexcept = 0;
        [[nodiscard]] virtual std::string_view GetVersion() const noexcept { 
            return "1.0.0"; 
        }
    };
}
```

### 4.3 EditorBridge API (C インターフェース)
```cpp
// EditorBridge/Public/EditorBridge.h
extern "C" {
    // エンジン管理
    BRIDGE_API void* CreateEditorEngine();
    BRIDGE_API void DestroyEditorEngine(void* engine);
    BRIDGE_API bool InitializeEngine(void* engine, const char* configJson);
    
    // ビューポート管理
    BRIDGE_API void* CreateViewport(void* engine, void* hwnd, int width, int height);
    BRIDGE_API void ResizeViewport(void* viewport, int width, int height);
    BRIDGE_API void RenderViewport(void* viewport);
    
    // ECS操作
    BRIDGE_API uint32_t CreateEntity(void* engine, const char* name);
    BRIDGE_API void DestroyEntity(void* engine, uint32_t entityId);
    BRIDGE_API void AddComponent(void* engine, uint32_t entityId, const char* componentJson);
    
    // アセット管理
    BRIDGE_API bool ImportAsset(void* engine, const char* path, const char* type);
    BRIDGE_API const char* GetAssetList(void* engine, const char* filter);
}
```

## 5. レンダリングアーキテクチャ

### 5.1 抽象化レイヤー
```cpp
namespace elk::rendering {
    // Renderer Hardware Interface
    class RHI {
    public:
        virtual ~RHI() = default;
        
        [[nodiscard]] virtual std::expected<CommandList*, Error> 
            CreateCommandList() = 0;
        
        [[nodiscard]] virtual std::expected<Pipeline*, Error> 
            CreatePipeline(const PipelineDesc& desc) = 0;
        
        virtual void Submit(std::span<CommandList*> cmdLists) = 0;
    };
    
    // DirectX 12 実装
    class D3D12RHI final : public RHI { /* ... */ };
    
    // Vulkan 実装
    class VulkanRHI final : public RHI { /* ... */ };
}
```

### 5.2 レンダーグラフ
```cpp
namespace elk::rendering {
    class RenderGraph {
    public:
        // パスの追加
        template<typename Data>
        void AddPass(std::string_view name, 
                    PassSetup<Data> setup,
                    PassExecute<Data> execute);
        
        // リソースの宣言
        [[nodiscard]] TextureHandle CreateTexture(const TextureDesc& desc);
        [[nodiscard]] BufferHandle CreateBuffer(const BufferDesc& desc);
        
        // コンパイルと実行
        void Compile();
        void Execute(RHI& rhi);
    };
}
```

## 6. Entity Component System (ECS)

### 6.1 基本設計
```cpp
namespace elk::ecs {
    // エンティティ = ID
    using Entity = uint32_t;
    
    // コンポーネント基底
    template<Component T>
    class ComponentStorage {
        std::vector<T> m_components;
        std::unordered_map<Entity, size_t> m_entityToIndex;
    };
    
    // ワールド
    class World {
    public:
        [[nodiscard]] Entity CreateEntity();
        void DestroyEntity(Entity entity);
        
        template<Component T, typename... Args>
        T& AddComponent(Entity entity, Args&&... args);
        
        template<Component T>
        [[nodiscard]] T* GetComponent(Entity entity);
        
        template<typename... Components>
        [[nodiscard]] auto View();
    };
}
```

## 7. ビルドシステム

### 7.1 CMake設定
```cmake
cmake_minimum_required(VERSION 4.0)
project(ElkGameEngine LANGUAGES CXX)

# C++20設定
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# モジュールサポート
set(CMAKE_EXPERIMENTAL_CXX_MODULE_DYNDEP ON)
set(CMAKE_EXPERIMENTAL_CXX_MODULE_CMAKE_API "aa1f7df0-828a-4fcd-9afc-2dc80491aca7")

# プロジェクト構成
add_subdirectory(ElkEngine)
add_subdirectory(EditorBridge)
add_subdirectory(Runtime)

if(BUILD_EDITOR)
    message(STATUS "C# Editor: Editor/ElkEditor.csproj")
endif()

if(BUILD_SAMPLES)
    add_subdirectory(Samples)
endif()
```

### 7.2 ビルドスクリプト
```batch
@echo off
REM Scripts/build.bat

set BUILD_TYPE=Debug
set COMPILER=VS2022

REM C++ビルド
cmake -B build -G "Visual Studio 17 2022" ^
      -DCMAKE_BUILD_TYPE=%BUILD_TYPE% ^
      -DBUILD_EDITOR=ON
      
cmake --build build --config %BUILD_TYPE% --parallel

REM C#エディタビルド
if exist Editor (
    dotnet build Editor/ElkEditor.csproj -c %BUILD_TYPE%
    
    REM DLLコピー
    copy build\%BUILD_TYPE%\bin\*.dll Editor\bin\%BUILD_TYPE%\net9.0-windows\
)
```

## 8. 開発ロードマップ

### Phase 1: 基盤 (2週間)
- [ ] プロジェクト構造
- [ ] CMake設定 (C++20)
- [ ] 基本Engine/Application
- [ ] Win32ウィンドウ

### Phase 2: レンダリング (3週間)
- [ ] RHI抽象化
- [ ] DirectX 12実装
- [ ] 基本的な描画
- [ ] シェーダーシステム

### Phase 3: エディタ統合 (2週間)
- [ ] EditorBridge実装
- [ ] C# WPFエディタ
- [ ] ビューポート統合

### Phase 4: ECS (2週間)
- [ ] Entity/Component設計
- [ ] System実装
- [ ] シリアライゼーション

### Phase 5: アセット (2週間)
- [ ] アセットローダー
- [ ] モデル/テクスチャ
- [ ] アセットブラウザ

### Phase 6: 高度な機能 (3週間)
- [ ] Vulkan対応
- [ ] 物理エンジン統合
- [ ] オーディオシステム

## 9. 品質基準

### パフォーマンス
- レンダリング: 144 FPS (1080p)
- メモリ使用量: < 2GB (エディタ)
- 起動時間: < 3秒

### コード品質
- 警告レベル: /W4 (MSVC)
- 静的解析: PVS-Studio
- テストカバレッジ: > 70%

## 10. チェックリスト

### 環境構築
- [ ] Visual Studio 2022
- [ ] CMake 4.0+
- [ ] .NET 9 SDK
- [ ] Windows 11 SDK
- [ ] DirectX 12 Agility SDK
- [ ] Vulkan SDK

### Phase 1 完了条件
- [ ] CMakeビルド成功
- [ ] ウィンドウ表示
- [ ] 基本的なログシステム
- [ ] エンジン初期化/終了

### Phase 2 完了条件
- [ ] 三角形描画
- [ ] シェーダーコンパイル
- [ ] 基本的なカメラ
- [ ] DirectX 12動作確認

### Phase 3 完了条件
- [ ] エディタ起動
- [ ] ビューポート表示
- [ ] エンジン制御
- [ ] P/Invoke動作確認

### Phase 4 完了条件
- [ ] Entity作成/削除
- [ ] Component追加/削除
- [ ] System実行
- [ ] 基本的なTransform

### Phase 5 完了条件
- [ ] OBJファイル読み込み
- [ ] テクスチャ表示
- [ ] アセットブラウザ
- [ ] ドラッグ&ドロップ

### Phase 6 完了条件
- [ ] Vulkan切り替え
- [ ] 物理シミュレーション
- [ ] 3Dオーディオ
- [ ] プロファイラー統合

## 11. 命名規則

| 要素 | 規則 | 例 |
|------|------|-----|
| 名前空間 | 小文字 | `elk::rendering` |
| クラス | PascalCase | `RenderSystem` |
| 関数 | PascalCase | `Initialize()` |
| 変数 | camelCase | `deltaTime` |
| メンバ変数 | m_camelCase | `m_isRunning` |
| 定数 | UPPER_SNAKE | `MAX_ENTITIES` |
| テンプレート | PascalCase | `ComponentStorage<T>` |
| コンセプト | PascalCase | `Component` |

## 12. 外部ライブラリ

| ライブラリ | 用途 | ライセンス |
|-----------|------|------------|
| **DirectXMath** | 数学演算 | MIT |
| **D3D12 Memory Allocator** | GPU メモリ管理 | MIT |
| **Vulkan Memory Allocator** | Vulkan メモリ管理 | MIT |
| **mimalloc** | メモリアロケータ | MIT |
| **spdlog** | ログシステム | MIT |
| **Tracy** | プロファイラー | BSD |
| **Jolt Physics** | 物理エンジン | MIT |

---

**最終更新日:** 2025年9月15日  
**バージョン:** 1.0.0  
**作成者:** ElkEngine開発チーム